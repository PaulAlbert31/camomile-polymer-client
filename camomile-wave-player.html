<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>

<dom-module id="camomile-wave-player">

  <template>
    <template is="dom-if" if="{{loading}}">
      <p>Loading waveform {{loadingProgress}}%...</p>
    </template>
    <div id="waveform"></div>
  </template>

  <script>
    class CamomileWavePlayer extends Polymer.Element {
      static get is() {
        return "camomile-wave-player";
      }

      constructor() {
        super();
        this.loading=false;
        this.loaded=false;
      }

      ready() {
        super.ready();
        this.loading=false;

        const wavesurfer = WaveSurfer.create({
          container: this.$.waveform,
          xhrWithCredentials: true
        });


        const mediumView = document.getElementById(this.srcMediumView);

        mediumView.addEventListener("ready", () => {
          wavesurfer.load(mediumView.medium_url);
          this.loading=true;
          wavesurfer.on("ready",() => {
            this.loading=false;
            this.loaded=true;
          });
          wavesurfer.on("loading",(loadingProgress) => {
            this.loadingProgress=loadingProgress;
          })
        });

        mediumView.addEventListener("reset", () => {
          wavesurfer.empty();
          this.loading=false;
          this.loaded=false;
        });

        this.beingSought=false;
        wavesurfer.on("seek",() => {
          if(this.beingSought)
            return;
          mediumView.currentTime=wavesurfer.getCurrentTime();
          mediumView.dispatchEvent(new CustomEvent("timeupdate",{detail:{sender:this.id}}));
        });


        mediumView.addEventListener("timeupdate",({detail:{sender}}) => {
          if (sender === this.id)
            return;
          this.beingSought=true;
          wavesurfer.seekAndCenter(mediumView.currentTime/wavesurfer.getDuration());
          this.beingSought=false;
        });


        mediumView.addEventListener("rangechanged",({detail:{sender}}) => {
          if (sender === this.id || !this.loaded)
            return;

          wavesurfer.zoom(this.$.waveform.clientWidth/(mediumView.range.end-mediumView.range.start));
        });
      }

      static get properties() {
        return {
          srcMediumView: String,
          id: String
        }
      }
    }
    customElements.define(CamomileWavePlayer.is, CamomileWavePlayer);
  </script>

</dom-module>