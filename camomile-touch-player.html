<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="getElementAt.js"></script>
<script src="node_modules/hammerjs/hammer.min.js"></script>
<script src="node_modules/svgjs/dist/svg.min.js"></script>
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"/>
<meta http-equiv="X-UA-Compatible" content='IE-Edge'/>
<!-- android -->
<meta name="mobile-web-app-capable" content="yes">
<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="translucent-black">
<meta name="apple-mobile-web-app-title" content="My App">
<meta name="format-detection" content="telephone=no" />

<dom-module id="camomile-touch-player">

  <template>
    <video id="video"
    width=auto height=auto >
    <source src="{{medium_url}}" type="video/{{format}}">
    </video>
    <style>
    html,body{
      overflow-y: hidden;
    }
    #button{--webkit-appearance:push-button}
    </style>
    <script type="text/javascript">

    var lastMove=null;
    var i=0;
    var start=[0,0,0];
    var player = document.getElementById('player1').$.video;
    var videoElement = player;
    var videoHeight = videoElement.clientHeight;
    var videoWidth = videoElement.clientHeight;
    var parent = document.getElementById('vid');
    function _wrap(){
      if(videoElement.parentNode.id==undefined){
        var button=document.createElement('button');
        button.innerHTML='Play';
        document.getElementById('log').appendChild(button);
        button.addEventListener('tap',function(){
          player.play();
        })

        var wrapper = document.createElement('div');

        wrapper.id = 'interactivePlayer';
        // see "how to maintain the aspect ratio of a div using only CSS
        // http://stackoverflow.com/questions/1495407/how-to-maintain-the-aspect-ratio-of-a-div-using-only-css


        // Work in progress
        // var arrowHead = this.draw.marker(2,2,function(add) {
        //   var rectangle=add.rect(videoHeight/25,videoHeight/25).fill({color:'#f06',opacity:0});
        // });
        //
        // arrow.marker('end',arrowHead)
        parent.replaceChild(wrapper, document.getElementById('player1'));

        // add touch overlay on top of player
        var touchLayer = document.createElement('div');
        touchLayer.id = 'interaction';
        // touchLayer.appendChild(videoElement);
        wrapper.appendChild(touchLayer);
        wrapper.appendChild(videoElement);
        this.draw=SVG('interaction').size(videoElement.videoWidth,videoElement.videoHeight);
        // add Hammer to touch overlay
        var hammer = new Hammer.Manager(touchLayer);
        // Tap recognizer with minimal 2 taps
        hammer.add( new Hammer.Tap({ event: 'doubletap', taps: 2, interval:500, posThreshold:50 }) );
        // Single tap recognizer
        hammer.add( new Hammer.Tap({ event: 'singletap' }) );
        // Pan recognizer
        hammer.add(new Hammer.Pan({event:'pan'}));
        // Pinch recognizer
        hammer.add(new Hammer.Pinch({event:'pinch'}))

        // we want to recognize this simulatenous, so a doubletap will be detected even while a tap has been recognized.
        hammer.get('doubletap').recognizeWith('singletap');
        // we only want to trigger a tap, when we don't have detected a doubletap
        hammer.get('singletap').requireFailure('doubletap');
        // we only want to pinch if taps fail
        hammer.get('pan').requireFailure('pinch')

        hammer.on('singletap', function(event) {
          height = videoElement.clientHeight;
          width = videoElement.clientWidth;
          offsetY=document.getElementById("log").clientHeight+document.getElementById('vid').clientHeight;
          offsetX=document.getElementById('vid').offsetLeft;
          console.log(event);
          if (player.paused&&player.currentTime==0){
            player.play();
          }else{
            circle.center((event.center.x),event.center.y-offsetY);
            circle.fill({opacity:0.8}).animate(500).fill({opacity:0});
            console.log({'type': event,
            'x': (event.center.x)/width,
            'y': (event.center.y-offsetY)/height,
            'currentTime': player.currentTime});
          }});
          hammer.on('doubletap', function() {
            if (player.paused) {
              player.play()
            } else {
              player.pause()
            }
          });

          hammer.on('pinchout', function(event) {
            if (i==8&&player.playbackRate<1.9) {
              i=0;
              player.playbackRate+=0.2;
              console.log(player.playbackRate)
              console.log({'type': event.type,
              'currentTime': player.currentTime,'i':i});
            } else if(player.playbackRate<1.9){
              i++;
            }

          });

          hammer.on('pinchin', function(event) {
            if (i==8&&player.playbackRate>0.41) {
              i=0;
              player.playbackRate-=0.2;
              console.log(player.playbackRate)
              console.log({'type': event.type,
              'currentTime': player.currentTime,'i':i});
            } else if(player.playbackRate>0.41){
              i++;
            }
          });

          hammer.on('panstart', function(event) {
            height = videoElement.clientHeight;
            width = videoElement.clientWidth;
            offsetY=document.getElementById("log").clientHeight+document.getElementById('vid').clientHeight;
            start=[(event.center.x),event.center.y-offsetY,player.currentTime]
            offsetX=document.getElementById('vid').offsetLeft;
            console.log({'type': event.type,
            'x': (event.center.x)/width,
            'y': (event.center.y-offsetY)/height,
            'currentTime': player.currentTime});
          });
          hammer.on('panend', function(event) {
            height = videoElement.clientHeight;
            width = videoElement.clientWidth;
            offsetY=document.getElementById("log").clientHeight+document.getElementById('vid').clientHeight;
            offsetX=document.getElementById('vid').offsetLeft;
            console.log({'type': event.type,
            'x': (event.center.x)/width,
            'y': (event.center.y-offsetY)/height,
            'currentTime': player.currentTime});
            if (player.currentTime-start[2]<2) {
              arrow.animate(500).stroke({opacity:0.8}).plot(start[0],start[1],(event.center.x),event.center.y-offsetY).animate(1000).stroke({opacity:0});
            }
          });
        }else{
          var wrapper=parent;
          var touchLayer = document.getElementById('interaction');
        }

        var circle=this.draw.circle(videoHeight/10).fill({color:'#f06',opacity:0});
        var arrow=this.draw.line(0,0,100,100).stroke({color:'#f06',opacity:0,width:10});
        // see "how to maintain the aspect ratio of a div using only CSS
        // http://stackoverflow.com/questions/1495407/how-to-maintain-the-aspect-ratio-of-a-div-using-only-css


        // Work in progress
        // var arrowHead = this.draw.marker(2,2,function(add) {
        //   var rectangle=add.rect(videoHeight/25,videoHeight/25).fill({color:'#f06',opacity:0});
        // });
        //
        // arrow.marker('end',arrowHead)

      };
      videoElement.addEventListener('loadedmetadata', _wrap);
      videoElement.addEventListener('canplay',function(){
        console.log('canplay');
      });

      document.ontouchmove = function(event){
        event.preventDefault();
      }
      </script>
    </template>

    <script>
    class CamomilePlayer extends Polymer.Element {
      static get is() {
        return "camomile-touch-player";
      }

      constructor() {
        super();
      }

      _setupMediumView(mediumView) {
        console.log("setting player",this.id,"to",mediumView.medium_url);
        this.medium_url = mediumView.medium_url;
        this.format = mediumView.format;
        this.$.video.load();
      }


      _resetMediumView() {
        console.log("reset player",this.id);
        this.medium_url="";
        this.format="";
        this.$.video.load();
      }

      ready() {

        super.ready();
        let syncCurrentTime;
        let syncAll;
        let syncPlaying;
        this.video=this.$.video;


        if(this.syncAll) {
          syncAll = getElementAt(this.syncAll);

          if(syncAll.medium) {
            this._setupMediumView(syncAll);
          }

          syncAll.addEventListener("ready", () => this._setupMediumView(syncAll));
          syncAll.addEventListener("reset", () => this._resetMediumView());
          syncCurrentTime=syncAll;
          syncPlaying=syncAll;
        }

        if(this.syncCurrentTime) {
          syncCurrentTime = getElementAt(this.syncCurrentTime);

          if(syncCurrentTime.medium) {
            this._setupMediumView(syncCurrentTime)
          }
          syncCurrentTime.addEventListener("ready", () => this._setupMediumView(syncCurrentTime));
          syncCurrentTime.addEventListener("reset", () => this._resetMediumView());
        }

        if(this.syncPlaying) {
          syncPlaying = getElementAt(this.syncPlaying);

          if(syncPlaying.medium) {
            this._setupMediumView(syncPlaying)
          }
          syncPlaying.addEventListener("ready", () => this._setupMediumView(syncPlaying));
          syncPlaying.addEventListener("reset", () => this._resetMediumView());
        }

        if(syncCurrentTime) {
          this.video.addEventListener("timeupdate",() => {
            syncCurrentTime.publish(this.id,"currentTime",this.video.currentTime);
          });
          syncCurrentTime.subscribe(this.id,"currentTime",() => {
            this.video.currentTime=syncCurrentTime.currentTime;
          });
        }


        if(syncPlaying) {
          this.video.addEventListener("play", () => {
            syncPlaying.publish(this.id,"playing",true);
          });
          this.video.addEventListener("pause", () => {
            syncPlaying.publish(this.id,"playing",false);
          });
        }
      }


      static get properties() {
        return {
          syncCurrentTime: String,
          syncPlaying: String,
          syncAll: String,
          id: String
        }
      }
    }
    customElements.define(CamomilePlayer.is, CamomilePlayer);
    </script>

  </dom-module>
