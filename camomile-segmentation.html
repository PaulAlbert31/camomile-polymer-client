<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymer/lib/elements/dom-repeat.html">

<script src="node_modules/vis/dist/vis.js"></script>


<dom-module id="camomile-segmentation">

  <link rel="import" type="css" href="node_modules/vis/dist/vis-timeline-graph2d.min.css">
  <template>

    <form id="edit" style="display:none;">
      <label>Label : <input type="text" id="label" /></label>
      <input type="submit" value="Validate" />
    </form>

    <div id="visualization"></div>

  </template>

  <script>
    // TODO : fix simple click
    class CamomileSegmentation extends Polymer.Element {
      static get is() {
        return "camomile-segmentation";
      }

      constructor() {
        super();
      }

      _loadVis() {
        this.items = new vis.DataSet({
          type: { start: 'Number', end: 'Number' }
        });




        const container = this.$.visualization;
        const options = {
          start: 0,
          end: 10000,
          height: '300px',
          multiselect: true,
          showCurrentTime:false,
          editable: true,
          //showCurrentTime: true,
          //rollingMode: true,
          onAdd: (item, callback) => {
            this.$.edit.style="display: block";
            this.$.label.focus();

            this.$.edit.onsubmit=(e) => {
              e.preventDefault();
              item.content=this.$.label.value;
              item.end=item.start+100;
              this.$.label.value="";
              this.$.edit.style="display:none";
              this.$.edit.onsubmit=null;
              const {start,end,content}=item;
              this.client.createAnnotation(this.layer,this.medium,{start,end},content)
                .then(result => {
                  item.id=result._id;
                  callback(item);
                });
            };
          },

          onUpdate: (item, callback) => {
            this.$.edit.style="display: block";
            this.$.label.focus();
            this.$.label.value=item.content;

            this.$.edit.onsubmit=(e) => {
              e.preventDefault();
              item.content=this.$.label.value;
              this.$.label.value="";
              this.$.edit.style="display:none";
              this.$.edit.onsubmit=null;
              callback(item);
            };
          },
        };

        this.timeline = new vis.Timeline(container, this.items, options);
        this.timeline.addCustomTime(0,1);

        const mediumView = document.getElementById(this.srcMediumView);

        this.editingTime=false;
        mediumView.addEventListener("timeupdate",({detail:{sender}}) => {
          if(this.editingTime || sender===this.id)
            return;
          this.timeline.setCustomTime(mediumView.currentTime,1);
          this.timeline.moveTo(mediumView.currentTime);
        });


        this.timeline.on("timechange",() => {
          this.editingTime=true;
        });

        this.timeline.on("timechanged", () => {
          mediumView.currentTime=this.timeline.getCustomTime(1);
          mediumView.dispatchEvent(new CustomEvent("timeupdate",{detail:{sender:this.id}}));
          this.editingTime=false;
        });

        this.timeline.on("click", (e) => {
          this.timeline.setSelection(e.item);
        });

      }

      ready() {
        super.ready();

        const layerInstance = document.getElementById(this.srcLayer);

        layerInstance.addEventListener("select", ({detail: {layer}}) => {
          if(this.layer) {
            this.client.unwatchLayer(this.layer);
          }

          this.client = layerInstance.client;

          this.layer=layer;
          if(this.medium)
            this._populateAnnotations(this.layer,this.medium);

          this.client.watchLayer(layer, (data) => {

            const d=JSON.parse(data.data);
            console.log("watchLayer",d);

            if(d.event['update_annotation']) {
              this.client.getAnnotation(d.event['update_annotation'])
                .then(data => {
                  this.items.update(CamomileSegmentation._transformItem(data),17);
                })
            }

            if(d.event['delete_annotation']) {
              this.items.remove(d.event['delete_annotation'],17);
            }


            if(d.event['add_annotation']) {
              this.client.getAnnotation(d.event['add_annotation'])
                .then(data => {
                  if(this.items.get(d.event['add_annotation']))
                    return;
                  this.items.add(CamomileSegmentation._transformItem(data),17);
                })
            }


          });
        });


        layerInstance.addEventListener("deselect", () => {
          this.client= null;
          this.layer=null;
          this.annotations=null;
          this._clearTimeline();
        });


        const mediumViewInstance = document.getElementById(this.srcMediumView);

        mediumViewInstance.addEventListener("ready", () => {
          this.client = mediumViewInstance.client;
          this.medium=mediumViewInstance.medium;

          if(this.layer)
            this._populateAnnotations(this.layer,this.medium);
        });



        mediumViewInstance.addEventListener("reset", () => {
          this.client= null;
          this.medium=null;
          this.annotations=null;
          this._clearTimeline();
        });


        this._loadVis();

      }

      static _transformItem({_id,fragment:{start,end},data})
      {
        return {
          id: _id,
          start,
          end,
          content: data
        }
      }

      _clearTimeline() {
        this.items.off('*',this._printer);
        this.items.off('remove',this._remover);
        this.items.off('update',this._updater);
        this.items.clear();
      }

      _setupTimeline(data) {
        this.items.add(data.map(CamomileSegmentation._transformItem));
        this.timeline.setWindow(data[0].fragment.start,data[0].fragment.start+200,{animation:false});


        this._printer=(event, properties) => {
          console.log("timeline event",event, properties.items);
        };
        this.items.on('*', this._printer);

        this._remover=(event, properties,senderId) => {
          if(senderId===17)
            return;
          properties.items.forEach(annotation => this.client.deleteAnnotation(annotation));
        };

        this.items.on('remove', this._remover);

        this._updater=(event, properties,senderId) => {
          if(senderId===17)
            return;
          properties.items.forEach(annotation => {
            const item=this.items.get(annotation);
            this.client.updateAnnotation(annotation,{
              data:item.content,
              fragment:{
                start:item.start,
                end:item.end,
              }});

          });
        };
        this.items.on('update', this._updater);
      }

      _populateAnnotations(layer,medium) {
        this.client.getAnnotations({filter:{id_layer:layer,id_medium:medium}})
          .then(data => {
            console.log("annotations",data);

            this._clearTimeline();
            this._setupTimeline(data);

          })
          .catch(err => {
          });
      }

      static get properties() {
        return {
          srcLayer: String,
          srcMediumView: String,
          id: String
        };
      }
    }
    customElements.define(CamomileSegmentation.is, CamomileSegmentation);
  </script>

</dom-module>