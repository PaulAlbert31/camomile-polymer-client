<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymer/lib/elements/dom-repeat.html">

<script src="node_modules/vis/dist/vis.js"></script>


<dom-module id="camomile-segmentation">

  <link rel="import" type="css" href="node_modules/vis/dist/vis-timeline-graph2d.min.css">
  <template>

    <div id="visualization"></div>

  </template>

  <script>
    // TODO : fix simple click
    class CamomileSegmentation extends Polymer.Element {
      static get is() {
        return "camomile-segmentation";
      }

      constructor() {
        super();
      }

      _loadVis() {
        this.items = new vis.DataSet({
          type: { start: 'Number', end: 'Number' }
        });


        const container = this.$.visualization;
        const options = {
          start: 0,
          end: 10000,
          height: '300px',
          multiselect: true,
          editable: true,
          showCurrentTime: true
        };

        this.timeline = new vis.Timeline(container, this.items, options);
      }

      ready() {
        super.ready();
        console.log("id: " + this.id);

        console.log("srcLayer: " + this.srcLayer);
        console.log("srcMedium: " + this.srcMedium);

        const layerInstance = document.getElementById(this.srcLayer);

        layerInstance.addEventListener("select", ({detail: {layer}}) => {
          this.client = layerInstance.client;

          this.layer=layer;
          if(this.medium)
            this._populateAnnotations(this.layer,this.medium);

          this.client.watchLayer(layer, (data) => {
            console.log(data);
            const d=JSON.parse(data.data);
            console.log(d);

            if(d.event['update_annotation']) {
              this.client.getAnnotation(d.event['update_annotation'])
                .then(data => {
                  this.items.update(CamomileSegmentation._transformItem(data),17);
                })
            }


            // add medium specified or just refresh the whole media
            //this._populateAnnotations(layer);

          });
        });


        const mediumInstance = document.getElementById(this.srcMedium);

        mediumInstance.addEventListener("select", ({detail: {medium}}) => {
          this.client = mediumInstance.client;
          this.medium=medium;

          if(this.layer)
            this._populateAnnotations(this.layer,this.medium);
        });

        this._loadVis();

      }

      static _transformItem({_id,fragment:{start,end},data})
      {
        return {
          id: _id,
          start,
          end,
          content: data
        }
      }

      _populateAnnotations(layer,medium) {
        this.client.getAnnotations({filter:{id_layer:layer,id_medium:medium}})
          .then(data => {
            console.log(data);

            this.items.clear();
            this.items.add(data.map(CamomileSegmentation._transformItem));

            this.items.on('*', (event, properties) => {
              console.log(event, properties.items);
            });
            this.items.on('remove', (event, properties,senderId) => {
              if(senderId===17)
                return;
              properties.items.forEach(annotation => this.client.deleteAnnotation(annotation));
            });
            this.items.on('update', (event, properties,senderId) => {
              if(senderId===17)
                return;
              properties.items.forEach(annotation => {
                this.client.updateAnnotation(annotation,{
                fragment:{
                  start:this.items.get(annotation).start,
                  end:this.items.get(annotation).end,
                }});

              });
            });
          })
          .catch(err => {
          });
      }

      static get properties() {
        return {
          srcLayer: String,
          srcMedium: String,
          id: String
        };
      }
    }
    customElements.define(CamomileSegmentation.is, CamomileSegmentation);
  </script>

</dom-module>