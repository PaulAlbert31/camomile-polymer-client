<script src="node_modules/camomile-client/camomile.js"></script>

<link rel="import" href="node_modules/@polymer/polymer/polymer-element.html">
<link rel="import" href="node_modules/@polymer/polymer/lib/elements/dom-if.html">

<dom-module id="camomile-login">

  <template>
    <template is="dom-if" if="{{!logged_in}}">
      <form on-submit="login">
        <label>User: <input type="text" id="user" /></label>
        <label>Password: <input type="password" id="password" /></label>
        <input type="submit" value="Login"/>
      </form>
    </template>
    <template is="dom-if" if="{{logged_in}}">
      {{username}}
      <form on-submit="logout">
        <input type="submit" value="Logout"/>
      </form>
    </template>
    {{login_status}}
  </template>

  <script>
    class CamomileLogin extends Polymer.Element {
      static get is() {
        return "camomile-login";
      }

      constructor() {
        super();
      }

      ready() {
        super.ready();
        this.logged_in=false;


        const camomileInstance=document.getElementById(this.srcEndpoint);
        const url=camomileInstance.url;

        camomileInstance.addEventListener("endpointReset",() => {
          if(this.logged_in)
            this.logout();
        });


        this.client = new Camomile(url);
        this.authenticate();
      }

      authenticate() {
        this.client.me()
          .then(({username}) => {
            this.username=username;
            this.logged_in=true;
            return this.dispatchEvent(new CustomEvent('login', {}));
          })
          .catch(err => {
            this.logged_in=false;
          });
      }

      login(e) {
        e.preventDefault();
        const url = document.getElementById(this.srcEndpoint).url;
        this.client = new Camomile(url);


        this.client.login(this.shadowRoot.querySelector("#user").value, this.shadowRoot.querySelector("#password").value)
          .then(r => {
            console.log(r);
            this.authenticate();
            return this.dispatchEvent(new CustomEvent('login', {}));
          })
          .catch(e => {
            console.log(e);
            this.login_status="Login failed : "+e.message;
          });
      }

      logout(e) {
        if(e) e.preventDefault();
        this.client.logout().then(() => {
          this.logged_in=false;
          return this.dispatchEvent(new CustomEvent('logout', {}));
        })
      }

      static get properties() {
        return {
          srcEndpoint: String,
          id: String
        };
      }
    }
    customElements.define(CamomileLogin.is, CamomileLogin);
  </script>

</dom-module>