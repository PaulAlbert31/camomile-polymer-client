<link rel="import" href="node_modules/@polymer/polymer/polymer-element.html">
<link rel="import" href="node_modules/@polymer/polymer/lib/elements/dom-repeat.html">


<dom-module id="camomile-segmentation-table">

  <template>
    <table>
      <tr><th>Beginning</th><th>End</th><th>Label</th></tr>
      <template is="dom-repeat" items="{{annotations}}">
        <tr><td>{{item.fragment.start}}</td><td>{{item.fragment.end}}</td><td>{{item.data}}</td></tr>
      </template>
    </table>
  </template>

  <script>
    class CamomileSegmentationTable extends Polymer.Element {
      static get is() {
        return "camomile-segmentation-table";
      }

      constructor() {
        super();
      }

      ready() {
        super.ready();

        const layerInstance = document.getElementById(this.srcLayer);

        if(layerInstance.layer)
          this._setupLayer(layerInstance);
        layerInstance.addEventListener("select", () => this._setupLayer(layerInstance));
        layerInstance.addEventListener("deselect", () => this._resetLayer());

        const mediumInstance = document.getElementById(this.srcMedium);
        if(mediumInstance.medium)
          this._setupMedium(mediumInstance);
        mediumInstance.addEventListener("select", () => this._setupMedium(mediumInstance));
        mediumInstance.addEventListener("deselect", () => this._resetMedium());

      }

      _setupLayer(layerInstance) {
        if(this.layer) {
          this.client.unwatchLayer(this.layer);
        }

        this.client = layerInstance.client;
        this.layer=layerInstance.layer;
        if(this.medium)
          this._populateAnnotations(this.layer,this.medium);

        console.log("segmentation table watch layer",layerInstance.layer);
        this.client.watchLayer(layerInstance.layer, () => {
          this._populateAnnotations(this.layer,this.medium);
        });
      }

      _resetLayer() {
        this.client= null;
        this.layer=null;
        this.annotations=null;
      }

      _setupMedium(mediumInstance) {
        this.client = mediumInstance.client;
        this.medium=mediumInstance.medium;

        if(this.layer)
          this._populateAnnotations(this.layer,this.medium);
      }

      _resetMedium() {
        this.client= null;
        this.medium=null;
        this.annotations=null;
      }

      _populateAnnotations(layer,medium) {
        this.client.getAnnotations({filter:{id_layer:layer,id_medium:medium}})
          .then(data => {
            console.log("annotations",data);
            this.annotations = data.sort((a,b) => a.fragment.start - b.fragment.start);
          })
          .catch(err => {
          });
      }

      static get properties() {
        return {
          srcLayer: String,
          srcMedium: String,
          id: String
        };
      }
    }
    customElements.define(CamomileSegmentationTable.is, CamomileSegmentationTable);
  </script>

</dom-module>